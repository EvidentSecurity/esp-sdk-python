from __future__ import absolute_import

import unittest
import json
import math
import os
from esp_sdk.configuration import Configuration

c = Configuration()
os.environ['ESP_ENV'] = 'test'
c.access_key_id = 'abc'
c.secret_access_key = '345'

class TestBase(unittest.TestCase):
    import esp_sdk as esp_sdk
    import json as json
    from mock import Mock as mock

    def active_record_error_response(self):
        return json.dumps({"errors": [{"status": "401", "title": "Name can't be blank", "meta": {"name": "can't be blank"}}, {"status": "401", "title": "Name is invalid", "meta": {"name": "is invalid"}}, {"status": "401", "title": "Description can't be blank", "meta": {"description": "can't be blank"}}]})

    def organization_response(self):
        return json.dumps({"included": None, "data": {"id": 1, "type": "organizations", "relationships": {"sub_organizations": {"data": [{"type": "sub_organizations", "id": "24"}, {"type": "sub_organizations", "id": "2"}], "links": {"related": "http://localhost:3000/api/v2/sub_organizations.json?filter%5Borganization_id_eq%5D=2"}}, "teams": {"data": [{"type": "teams", "id": "2"}, {"type": "teams", "id": "20"}, {"type": "teams", "id": "21"}], "links": {"related": "http://localhost:3000/api/v2/teams.json?filter%5Borganization_id_eq%5D=2"}}}, "attributes": {"created_at": "2017-03-13 11:44:31 -0400", "name": "Test Org", "updated_at": "2017-03-13 11:44:31 -0400"}}})

    def alert_response(self):
        return json.dumps({"data": {"id": "1019", "type": "alerts", "attributes": {"created_at": "2018-03-15T19:29:33.678Z", "status": "fail", "risk_level": "high", "resource": "resource-6", "ended_reason": None, "replaced_by_id": None, "replaced_by_status": None, "updated_at": "2018-03-15T19:29:33.678Z", "started_at": "2018-03-15T19:28:33.000Z", "ended_at": None}, "relationships": {"external_account": {"data": {"id": "1", "type": "external_accounts"}, "links": {"related": "http://test.host/api/v2/external_accounts/1.json"}}, "region": {"data": {"id": "1018", "type": "regions"}, "links": {"related": "http://test.host/api/v2/regions/1018.json"}}, "signature": {"data": {"id": "1", "type": "signatures"}, "links": {"related": "http://test.host/api/v2/signatures/1.json"}}, "custom_signature": {"data": None, "links": {"related": None}}, "suppression": {"data": {"id": "1017", "type": "suppressions"}, "links": {"related": "http://test.host/api/v2/suppressions/1017.json"}}, "metadata": {"links": {"related": "http://test.host/api/v2/alerts/1019/metadata.json"}}, "attribution": {"data": {"id": "1015", "type": "attributions"}, "links": {"related": "http://test.host/api/v2/alerts/1019/attribution.json"}}, "cloud_trail_events": {"links": {"related": "http://test.host/api/v2/alerts/1019/cloud_trail_events.json"}}, "tags": {"data": [{"id": "", "type": "tags"}, {"id": "", "type": "tags"}], "links": {"related": "http://test.host/api/v2/alerts/1019/tags.json"}}, "compliance_controls": {"data": [{"id": "1", "type": "compliance_controls"}], "links": {"related": "http://test.host/api/v2/alerts/1019/compliance_controls.json"}}, "custom_compliance_controls": {"links": {"related": "http://test.host/api/v2/alerts/1019/custom_compliance_controls.json"}}}}, "included": [{"id": "1", "type": "external_accounts", "attributes": {"created_at": "2018-03-15T19:29:33.000Z", "name": "Amazon Account 3", "updated_at": "2018-03-15T19:29:33.000Z", "provider": "amazon", "arn": "arn:aws:iam::3768:role/test_sts_role", "account": "3768", "external_id": "test_sts_external_id_1", "cloudtrail_name": None}, "relationships": {"organization": {"links": {"related": "http://test.host/api/v2/organizations/3.json"}}, "sub_organization": {"links": {"related": "http://test.host/api/v2/sub_organizations/3.json"}}, "team": {"data": {"id": "3", "type": "teams"}, "links": {"related": "http://test.host/api/v2/teams/3.json"}}, "scan_intervals": {"links": {"related": "http://test.host/api/v2/external_accounts/1/scan_intervals.json"}}, "disabled_signatures": {"links": {"related": "http://test.host/api/v2/external_accounts/1/disabled_signatures.json"}}, "suppressions": {"links": {"related": "http://test.host/api/v2/suppressions.json?filter%5Bexternal_accounts_id_eq%5D=1"}}, "credentials": {"links": {"related": "http://test.host/api/v2/external_accounts/1/amazon.json"}}}}, {"id": "3", "type": "teams", "attributes": {"name": "Operations 3", "created_at": "2018-03-15T19:29:33.000Z", "updated_at": "2018-03-15T19:29:33.000Z"}, "relationships": {"custom_signatures": {"links": {"related": "http://test.host/api/v2/custom_signatures.json?filter%5Bteam_id_eq%5D=3"}}, "external_accounts": {"links": {"related": "http://test.host/api/v2/external_accounts.json?filter%5Bteam_id_eq%5D=3"}}, "organization": {"links": {"related": "http://test.host/api/v2/organizations/3.json"}}, "sub_organization": {"data": {"id": "3", "type": "sub_organizations"}, "links": {"related": "http://test.host/api/v2/sub_organizations/3.json"}}}}, {"id": "3", "type": "sub_organizations", "attributes": {"name": "IT Department 3", "created_at": "2018-03-15T19:29:33.000Z", "updated_at": "2018-03-15T19:29:33.000Z"}, "relationships": {"external_accounts": {"links": {"related": "http://test.host/api/v2/external_accounts.json?filter%5Bsub_organization_id_eq%5D=3"}}, "organization": {"links": {"related": "http://test.host/api/v2/organizations/3.json"}}, "teams": {"links": {"related": "http://test.host/api/v2/teams.json?filter%5Bsub_organization_id_eq%5D=3"}}}}, {"id": "1018", "type": "regions", "attributes": {"code": "us_east_test_7", "name": None, "created_at": "2018-03-15T19:29:34.213Z", "updated_at": "2018-03-15T19:29:34.213Z", "provider": "amazon"}}, {"id": "1", "type": "signatures", "attributes": {"created_at": "2018-03-15T19:29:33.000Z", "description": "[url](Some) description for *some* test", "identifier": "AWS:EC2-004", "name": "Signature 4", "resolution": "Turn on some setting", "risk_level": "high", "updated_at": "2018-03-15T19:29:33.000Z"}, "relationships": {"service": {"links": {"related": "http://test.host/api/v2/services/4.json"}}, "disabled_external_accounts": {"links": {"related": "http://test.host/api/v2/signatures/1/disabled_external_accounts.json"}}, "suppressions": {"links": {"related": "http://test.host/api/v2/suppressions.json?filter%5Bsignatures_id_eq%5D=1"}}}}, {"id": "1017", "type": "suppressions", "attributes": {"created_at": "2018-03-15T19:29:34.215Z", "reason": "No me gusta", "resource": None, "suppression_type": None, "status": "active", "updated_at": "2018-03-15T19:29:34.215Z"}, "relationships": {"organization": {"links": {"related": "http://test.host/api/v2/organizations/7.json"}}, "created_by": {"links": {"related": "http://test.host/api/v2/users/1016.json"}}, "regions": {"links": {"related": "http://test.host/api/v2/regions.json?filter%5Bsuppressions_id_eq%5D=1017"}}, "external_accounts": {"links": {"related": "http://test.host/api/v2/external_accounts.json?filter%5Bsuppressions_id_eq%5D=1017"}}, "signatures": {"links": {"related": "http://test.host/api/v2/signatures.json?filter%5Bsuppressions_id_eq%5D=1017"}}, "custom_signatures": {"links": {"related": "http://test.host/api/v2/custom_signatures.json?filter%5Bsuppressions_id_eq%5D=1017"}}}}, {"id": "1015", "type": "attributions", "attributes": {"event_id": "1", "event_name": "1", "event_time": "2018-03-15T19:29:33.000Z", "raw_event": {"sdk_integration_tests": "event data"}, "user": "arn:aws:iam::34234234234:user/johndoe", "ip_address": "123.0.0.123", "scope_name": "agent123"}, "relationships": {"alert": {"links": {"related": "http://test.host/api/v2/alerts/1019.json"}}}}, {"id": "1", "type": "tags", "attributes": {"key": "Name", "value": "abc123", "created_at": "2018-03-15T19:29:33.000Z", "updated_at": "2018-03-15T19:29:33.000Z"}}, {"id": "1", "type": "compliance_controls", "attributes": {"created_at": "2018-03-15T19:29:33.000Z", "name": "Control name 1", "identifier": "Control identifier 1", "description": "Standard description 1", "updated_at": "2018-03-15T19:29:33.000Z", "position":1}, "relationships": {"compliance_standard": {"links": {"related": "http://test.host/api/v2/compliance_standards/1.json"}}, "compliance_domain": {"links": {"related": "http://test.host/api/v2/compliance_domains/1.json"}}, "signatures": {"links": {"related": "http://test.host/api/v2/compliance_controls/1/signatures.json"}}}}]})

    # helper to form the correct object when getting a collection of objects
    def json_list(self, json_array, page_args=None):
        page_args = page_args or {'page': {'number': 1, 'size': 20}}
        data = [json.loads(j)['data'] for j in json_array]
        links = self._build_links(data, page_args['page'])
        list = {'data': data[0:page_args['page']['size']],
                "links": links}
        if json_array[0]:
            list['included'] = json.loads(json_array[0]).get('included', None)
        return json.dumps(list)

    def _build_links(self, data, page):
        current_page = page['number']
        last_page = math.ceil(float(len(data)) / page['size'])
        links = {"self": "http://localhost:3000/api/v2/not_the_real_url/but_useful_for_testing.json?page%5Bnumber%5D={0}&page%5Bsize%5D={1}".format(current_page, page['size'])}
        if current_page != 1:
            links["prev"] = "http://localhost:3000/api/v2/not_the_real_url/but_useful_for_testing.json?page%5Bnumber%5D={0}&page%5Bsize%5D={1}".format(current_page - 1, page['size'])
        if current_page != last_page:
            links["next"] = "http://localhost:3000/api/v2/not_the_real_url/but_useful_for_testing.json?page%5Bnumber%5D={0}&page%5Bsize%5D={1}".format(current_page + 1, page['size'])
            links["last"] = "http://localhost:3000/api/v2/not_the_real_url/but_useful_for_testing.json?page%5Bnumber%5D={0}&page%5Bsize%5D={1}".format(last_page, page['size'])
        return links
